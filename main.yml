- name: Play 01 - Define variables
  hosts: main
  tags:
    - setup
  vars_files: 
    - /home/main/env/env.yml
  vars:
    main: "{{ env }}"
    main_host_vars: 
      host_user: "{{ main.host_user }}"
      host_pass: "{{ main.host_pass }}"
      host_ssh_public_keys: "{{ main.host_ssh_public_keys }}"
    main_aux:  
      web_user_data: "{{ lookup('template', 'data/user_data.web.j2', template_vars=dict(main_host_vars)) | trim }}"
      db_user_data: "{{ lookup('template', 'data/user_data.db.j2', template_vars=dict(main_host_vars)) | trim }}"
    main_droplet_list:
      - group: "db_master"
        main_data: "{{ main.db_master }}"
        user_data: "{{ main_aux.db_user_data }}"
      - group: "db_replica"
         main_data: "{{ main.db_replica }}"
         user_data: "{{ main_aux.db_user_data }}" 
      - group: "web"
         main_data: "{{ main.web }}"
         user_data: "{{ main_aux.web_user_data }}" 
         
  roles:  
  - role: droplets
    vars:
      droplets_hosts_group: "{{ item.group }}"
      droplets_hosts_file: "{{ main.hosts_file }}"
      droplets_api_token: "{{ main.api_token }}"
      droplets_host_user: "{{ main.host_user }}"
      droplets_host_pass: "{{ main.host_pass }}"
      droplets_user_data: "{{ item.value.user_data }}"
      droplets_info: "{{ item.main_data.info }}"
      droplets_tags: "{{ item.main_data.do_tags }}"
      droplets_list: "{{ item.main_data.droplets }}"
    with_items:
    - "{{ main_droplet_list }}"
    loop_control:
      label: "{{ item.group }}"

###############################################################################

- name: Play 02 - Wait for hosts to be ready
  hosts: host
  tags:
    - setup
  vars_files: 
    - /home/main/env/env.yml
  vars:
    main: "{{ env }}"
  gather_facts: no
  roles:
  - role: host_test
    vars:
      host_test_log_file: "{{ main.log_file }}"
      host_test_setup_last_line: "{{ main.setup_last_line }}"
      host_test_initial_connection_timeout: "{{ main.initial_connection_timeout }}"
      host_test_setup_finished_timeout: "{{ main.setup_finished_timeout }}"

###############################################################################
