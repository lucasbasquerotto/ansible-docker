- name: "{{ project_ctx_title }}"
  set_fact:
    project_ctx_base_dir: >-
      {{ project_files_cloud_dir }}/ctxs/{{ project_ctx_key }}
    project_ctx_secrets_dir: >-
      {{ project_secrets_cloud_dir }}/ctxs/{{ project_ctx_key }}
  tags: ["no_print"]

- name: "{{ project_ctx_title }} - project_ctx_var_dir"
  set_fact:
    project_ctx_var_dir: "{{ project_ctx_base_dir }}/var"
    project_ctx_map_path_repos: "{{ project_env_init.params.map_path_repos | default({}) }}"
  tags: ["no_print"]

# ctx - cloud repository

- name: "{{ project_ctx_title }} - validate - cloud repo - required"
  fail:
    msg: "cloud repo (under main) not specified for ctx [{{ project_ctx_key }}]"
  when: (project_env.main[project_ctx_key].repo | default('')) == ''
  tags: ["no_print"]

- name: "{{ project_ctx_title }} - project_ctx_main"
  set_fact:
    project_ctx_main: "{{ project_env.main[project_ctx_key] }}"
  tags: ["no_print"]

- name: "{{ project_ctx_title }} - project_ctx_cloud_repo_key"
  set_fact:
    project_ctx_cloud_repo_key: "{{ project_ctx_main.repo }}"
    project_ctx_cloud_env_repos: "{{ project_ctx_main.env_repos | default([]) }}"
  tags: ["no_print"]

- name: "{{ project_ctx_title }} - project_ctx_path_cloud"
  set_fact:
    project_ctx_path_cloud: >-
      {{
        project_ctx_map_path_repos[project_ctx_cloud_repo_key]
        | default('')
      }}
  tags: ["no_print"]

- name: "{{ project_ctx_title }} - project_ctx_cloud_repo_dir"
  set_fact:
    project_ctx_cloud_repo_dir: >-
      {{
        ((env_dev | bool) and (project_ctx_path_cloud != ''))
        | ternary(
          project_shared_repos_dir + '/clouds/' + project_ctx_path_cloud,
          project_ctx_base_dir + '/repo'
        )
      }}
  tags: ["no_print"]

- name: "{{ project_ctx_title }} - git cloud (main)"
  include_tasks: "git.yml"
  vars:
    git_title: "{{ project_ctx_title }} - git cloud"
    git_repo: "{{ project_env.repos[project_ctx_cloud_repo_key] | default({}) }}"
    git_ssh_src_dir: "{{ project_env_dir }}"
    git_secrets_dir: "{{ project_ctx_secrets_dir }}"
    git_repo_dir: "{{ project_ctx_cloud_repo_dir }}"
  tags: ["no_print"]

- name: "{{ project_ctx_title }} - git cloud env repos (main)"
  include_tasks: "git.yml"
  vars:
    project_ctx_item_label: >-
      {{ project_ctx_item.dir | default('') }}
      ({{ project_ctx_item.repo | default('') }})
    git_title: "{{ project_ctx_title }} - git cloud env repo [{{ project_ctx_item_label }}]"
    git_repo: "{{ project_env.repos[project_ctx_item.repo | default('')] | default({}) }}"
    git_ssh_src_dir: "{{ project_env_dir }}"
    git_secrets_dir: "{{ project_ctx_secrets_dir + '/' + project_ctx_item.dir }}"
    git_repo_dir: "{{ project_ctx_cloud_repo_dir + '/' + project_ctx_item.dir }}"
  loop: "{{ project_ctx_cloud_env_repos }}"
  loop_control:
    loop_var: project_ctx_item
    label: "{{ project_ctx_item_label }}"
  tags: ["no_print"]
