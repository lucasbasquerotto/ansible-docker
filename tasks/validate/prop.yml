- name: "{{ validate_prop_title }} - validate_prop_type"
  set_fact:
    validate_prop_type: "{{ validate_prop_schema_info.type | default('') }}"
  tags: ["no_print"]

- name: "{{ validate_prop_title }} - define the schema without unneeded props - initial"
  set_fact:
    validate_prop_schema_info_new: {}
  tags: ["no_print"]

- name: "{{ validate_prop_title }} - define the schema without unneeded props - fill"
  set_fact:
    validate_prop_schema_info_new: >-
      {{ validate_prop_schema_info_new | combine({ tmp_item.key: tmp_item.value }) }}
  when: tmp_item.key not in ["required"]
  loop: "{{ validate_prop_schema_info | dict2items | list }}"
  loop_control:
    loop_var: tmp_item
    label: "{{ tmp_item.key }}"
  tags: ["no_print"]

- name: "{{ validate_prop_title }} - validate non-list prop (block)"
  block:
    - name: "{{ validate_prop_title }} - validate_prop_allowed_props"
      set_fact:
        validate_prop_allowed_props:
          - "type"
          - "schema"
      tags: ["no_print"]

    - name: "{{ validate_prop_title }} - validate the allowed schema props"
      fail:
        msg: |
          Invalid property defined for the schema (type <{{ validate_prop_type }}>).
          Property: {{ tmp_item }}
          Allowed: {{ validate_prop_allowed_props | to_json }}
      when: tmp_item not in validate_prop_allowed_props
      loop: "{{ validate_prop_schema_info_new | dict2items | map(attribute='key') | sort | list }}"
      loop_control:
        loop_var: tmp_item
        label: "{{ tmp_item }}"
      tags: ["no_print_skipped"]
  when: validate_prop_type != 'list'

- name: "{{ validate_prop_title }} - validate the non-list property"
  include_tasks: "tasks/validate/elem.yml"
  vars:
    validate_elem_title: "{{ validate_prop_title }}"
    validate_elem_ctx: "{{ validate_prop_ctx }}"
    validate_elem_type: "{{ validate_prop_type }}"
    validate_elem_schema: "{{ validate_prop_schema_info_new.schema | default('') }}"
    validate_elem_value: "{{ validate_prop_value }}"
  when: validate_prop_type != 'list'
  tags: ["no_print_skipped"]

- name: "{{ validate_prop_title }} - validate list property (outer)"
  include_tasks: "tasks/validate/list.yml"
  vars:
    validate_list_title: "{{ validate_prop_title }} - list"
    validate_list_ctx: "{{ validate_prop_ctx }}"
    validate_list_value: "{{ validate_prop_value }}"
    validate_list_schema_info: "{{ validate_prop_schema_info_new }}"
  when: validate_prop_type == 'list'
  tags: ["no_print_skipped"]
