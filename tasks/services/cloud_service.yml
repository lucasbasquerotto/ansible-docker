- name: "{{ cloud_service_title }} - validate entrypoint service (must be a list)"
  fail:
    msg: "the cloud service list is not defined"
  when: cloud_service_list is not defined

- name: "{{ cloud_service_title }} - validate the cloud service state (required)"
  fail:
    msg: "the cloud service state is not defined"
  when: (cloud_service_state | default('')) == ''

- name: "{{ cloud_service_title }} - validate the cloud service state (value)"
  fail:
    msg: "the cloud service state ({{ cloud_service_state }}) should be either 'present' or 'absent'"
  when: not (cloud_service_state in ['present', 'absent'])

- name: "{{ cloud_service_title }} - cloud_service_next - handle previous cases"
  set_fact:
    cloud_service_next: "{{ tmp_next }}"
  vars:
    tmp_next:
      next: "{{ cloud_service_next | default({}) }}"
      title: "{{ cloud_service_run_title | default('') }}"
      list: "{{ cloud_service_main_list | default([]) }}"
      idx: "{{ cloud_service_main_idx | default(0) }}"
      namespace: "{{ cloud_service_main_list[cloud_service_main_idx].namespace | default('') }}"
  when: >-
    (cloud_service_main_idx | default(0) | int) < (cloud_service_main_list | default([]) | length)
  tags: ["no_print"]

- name: "{{ cloud_service_title }} - cloud_service_next - initialize"
  set_fact:
    cloud_service_next: {}
  when: cloud_service_next is not defined
  tags: ["no_print"]

- name: "{{ cloud_service_title }} - cloud_service_main_list"
  set_fact:
    cloud_service_original_title: "{{ cloud_service_title }}"
    cloud_service_main_list: []
    cloud_service_main_idx: 0
    cloud_service_pending_list: []
    cloud_service_name_list: []
    cloud_service_pending_idx: 0
  tags: ["no_print"]

- name: "{{ cloud_service_title }} - cloud_service_inner"
  set_fact:
    cloud_service_inner_title: "{{ cloud_service_original_title }}"
    cloud_service_inner_info: ""
    cloud_service_inner_name: ""
    cloud_service_inner_prev_name: ""
    cloud_service_inner:
      list: true
      services: "{{ cloud_service_list }}"
    cloud_service_inner_type: ""
    cloud_service_inner_tmp_dir: "{{ cloud_service_tmp_dir }}/main"
  tags: ["no_print"]

- name: "{{ cloud_service_title }} - recursive services"
  include_tasks: "tasks/services/cloud_service_recursive.yml"
  tags: ["no_print_skipped"]

- name: "{{ cloud_service_title }} - cloud_service_run_title"
  set_fact:
    cloud_service_run_title: "{{ cloud_service_original_title }} - run"
  tags: ["no_print"]

- name: "{{ cloud_service_run_title }} - cloud_service_continue - before"
  set_fact:
    cloud_service_continue: >-
      {{ (cloud_service_main_idx | int) < (cloud_service_main_list | length) }}
  tags: ["no_print"]

- name: "{{ cloud_service_run_title }} - execute the service(s)"
  include_tasks: "tasks/services/cloud_service_run.yml"
  when: cloud_service_continue | bool

# set continue as true because it may be called inside a another service
# (to continue running the parent service, if there is one)
- name: "{{ cloud_service_run_title }} - cloud_service_continue - after"
  set_fact:
    cloud_service_continue: true
  tags: ["no_print"]

# set previous values for the parent service (if there is one)
- name: "{{ cloud_service_run_title }} - cloud_service_next - after"
  set_fact:
    cloud_service_next: "{{ tmp_next.next | default({}) }}"
    cloud_service_run_title: "{{ tmp_next.title | default('') }}"
    cloud_service_main_list: "{{ tmp_next.list | default([]) }}"
    cloud_service_main_idx: "{{ tmp_next.idx | default(0) }}"
  vars:
    tmp_next: "{{ cloud_service_next | default({}) }}"
  tags: ["no_print"]
