cloud_vars:
  app: "{{ (env.discourse.containers.default | default({})) | combine(env.discourse.containers.app | default({})) }}"
  db_master: "{{ (env.discourse.containers.default | default({})) | combine(env.discourse.containers.db_master | default({})) }}"
  redis_master: "{{ (env.discourse.containers.default | default({})) | combine(env.discourse.containers.redis_master | default({})) }}"
  web: "{{ (env.discourse.containers.default | default({})) | combine(env.discourse.containers.web | default({})) }}"

cloud_aux:
  digital_ocean:
    tags:
    - "main"
    - "auto"
    - "dmz"
    - "web"
    - "redis"
    - "postgres"
    firewalls:
    - name: "auto"
      tags: ["auto"]
      inbound_rules:
      - ports: "22"
        sources:
          tags: ["main"]
      outbound_rules:
      - protocol: "tcp"
        ports: "1-65535"
        destinations:
          addresses: ["0.0.0.0/0", "::/0"]
      - protocol: "udp"
        ports: "1-65535"
        destinations:
          addresses: ["0.0.0.0/0", "::/0"]
      - protocol: "icmp"
        ports: "1-65535"
        destinations:
          addresses: ["0.0.0.0/0", "::/0"]
    - name: "dmz"
      tags: ["dmz"]
      inbound_rules:
      - ports: "80"
        sources:
          addresses: ["0.0.0.0/0", "::/0"]
      - ports: "443"
        sources:
          addresses: ["0.0.0.0/0", "::/0"]
    - name: "web"
      tags: ["web"]
      inbound_rules:
      - ports: "80"
        sources:
          tags: ["dmz"]
      - ports: "443"
        sources:
          tags: ["dmz"]
    - name: "redis"
      tags: ["redis"]
      inbound_rules:
      - ports: "6379"
        sources:
          tags: ["web"]
    - name: "postgres"
      tags: ["postgres"]
      inbound_rules:
      - ports: "5432"
        sources:
          tags: ["web"]

cloud_dns:
  cloudflare:
    task: "cloudflare_dns"
    zone: "{{ env.discourse.zone }}"
    credentials:
      account_email: "{{ env.discourse.cloudflare_email }}"
      account_api_token: "{{ env.discourse.cloudflare_token }}"
    main_record: "{{ env.discourse.domain }}"
    static:
    - title: "smtp dns records"
      type: "CNAME"
      list: "{{ env.discourse.smtp_dns | default([]) }}"

cloud:
  digital_ocean:
    layer1:
      app:
        role: "main_do"
        vars:
          main_do_instance_type: "app"
          main_do_title: "App Instance"
          main_do_hosts_file: "{{ env.discourse.hosts_file }}"
          main_do_api_token: "{{ env.discourse.cloud_api_token }}"
          main_do_host_user: "{{ env.discourse.cloud_host_user }}"
          main_do_host_pass: "{{ env.discourse.cloud_host_pass }}"
          main_do_ssh_public_keys: "{{ env.discourse.cloud_host_ssh_public_keys }}"
          main_do_all_tags: "{{ cloud_aux.digital_ocean.tags }}"
          main_do_all_firewalls: "{{ cloud_aux.digital_ocean.firewalls }}"
          main_do_tags: 
          - "auto"
          - "dmz"
          main_do_instance_count: "{{ (env.discourse.shutdown == 1) | ternary(0, 1) }}"
          main_do_instance_max: 1
          main_do_instance_group: "discourse_app"
          main_do_instance_name: "discourse-app"
          containers:
          - name: "app"
            vars: "{{ cloud_vars.app }}"
        extra:
          dmz: "{{ true | bool }}"
          load_balance: "{{ false | bool }}"

    layer2:
      db_master:
        role: "main_do"
        vars:
          main_do_instance_type: "db_master"
          main_do_title: "DB Instance"
          main_do_hosts_file: "{{ env.discourse.hosts_file }}"
          main_do_api_token: "{{ env.discourse.cloud_api_token }}"
          main_do_host_user: "{{ env.discourse.cloud_host_user }}"
          main_do_host_pass: "{{ env.discourse.cloud_host_pass }}"
          main_do_ssh_public_keys: "{{ env.discourse.cloud_host_ssh_public_keys }}"
          main_do_all_tags: "{{ cloud_aux.digital_ocean.tags }}"
          main_do_all_firewalls: "{{ cloud_aux.digital_ocean.firewalls }}"
          main_do_tags: 
          - "auto"
          - "postgres"
          main_do_instance_count: "{{ (env.discourse.shutdown == 1) | ternary(0, 1) }}"
          main_do_instance_max: 1
          main_do_instance_group: "discourse_db_master"
          main_do_instance_name: "discourse-db-master"
          containers:
          - name: "db"
            vars: "{{ cloud_vars.db_master }}"
        extra:
          dmz: "{{ false | bool }}"
          load_balance: "{{ false | bool }}"

      redis_master:
        role: "main_do"
        vars:
          main_do_instance_type: "redis_master"
          main_do_title: "Redis Instance"
          main_do_hosts_file: "{{ env.discourse.hosts_file }}"
          main_do_api_token: "{{ env.discourse.cloud_api_token }}"
          main_do_host_user: "{{ env.discourse.cloud_host_user }}"
          main_do_host_pass: "{{ env.discourse.cloud_host_pass }}"
          main_do_ssh_public_keys: "{{ env.discourse.cloud_host_ssh_public_keys }}"
          main_do_all_tags: "{{ cloud_aux.digital_ocean.tags }}"
          main_do_all_firewalls: "{{ cloud_aux.digital_ocean.firewalls }}"
          main_do_tags: 
          - "auto"
          - "redis"
          main_do_instance_count: "{{ (env.discourse.shutdown == 1) | ternary(0, 1) }}"
          main_do_instance_max: 1
          main_do_instance_group: "discourse_redis_master"
          main_do_instance_name: "discourse-redis-master"
          containers:
          - name: "redis"
            vars: "{{ cloud_vars.redis_master }}"
        extra:
          dmz: "{{ false | bool }}"
          load_balance: "{{ false | bool }}"

      web:
        role: "main_do"
        vars:
          main_do_instance_type: "web"
          main_do_title: "Web Instance"
          main_do_hosts_file: "{{ env.discourse.hosts_file }}"
          main_do_api_token: "{{ env.discourse.cloud_api_token }}"
          main_do_host_user: "{{ env.discourse.cloud_host_user }}"
          main_do_host_pass: "{{ env.discourse.cloud_host_pass }}"
          main_do_ssh_public_keys: "{{ env.discourse.cloud_host_ssh_public_keys }}"
          main_do_all_tags: "{{ cloud_aux.digital_ocean.tags }}"
          main_do_all_firewalls: "{{ cloud_aux.digital_ocean.firewalls }}"
          main_do_tags: 
          - "auto"
          - "web"
          - "dmz"
          main_do_instance_count: "{{ (env.discourse.shutdown == 1) | ternary(0, 1) }}"
          main_do_instance_max: 1
          main_do_instance_group: "discourse_web"
          main_do_instance_name: "discourse-web"
          containers:
          - name: "web_only"
            dynamic_host_vars:
            - name: "db_host"
              group: "discourse_db_master"
              count: "{{ (env.discourse.shutdown == 1) | ternary(0, 1) }}"
            - name: "redis_host"
              group: "discourse_redis_master"
              count: "{{ (env.discourse.shutdown == 1) | ternary(0, 1) }}"
            vars: "{{ cloud_vars.web }}"
        extra:
          dmz: "{{ true | bool }}"
          load_balance: "{{ false | bool }}"
