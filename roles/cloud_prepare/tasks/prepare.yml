### Create / Update the repository ###

- name: "{{ cloud_prepare_inner_title }} - create the repo directory"
  become: "{{ cloud_prepare_pod.root }}"
  file:
    path: "{{ cloud_prepare_repo_location }}"
    state: directory
    mode: "{{ (cloud_prepare_cloud.type == 'local') | ternary(0777, 0755) }}"

- set_fact:    
    cloud_prepare_pod_inner_repo: >-
      {{ cloud_prepare_repos_dict[cloud_prepare_pod.repo] }}

- include_role: 
    name: "cloud_git"
  vars:
    cloud_git_key: "{{ cloud_prepare_pod.repo }}"
    cloud_git_title: >-
      {{ cloud_prepare_inner_title }} - update the repo directory
      ({{ cloud_prepare_pod.repo }})
    cloud_git_become: "{{ cloud_prepare_pod.root }}"
    cloud_git_repo: "{{ cloud_prepare_pod_inner_repo.src }}"
    cloud_git_version: "{{ cloud_prepare_pod_inner_repo.version }}"
    cloud_git_private: "{{ cloud_prepare_pod_inner_repo.private | default(false) }}"
    cloud_git_key_file_encrypted: >-
      {{ cloud_prepare_env_dir }}/{{ cloud_prepare_pod_inner_repo.key_file_encrypted }}
    cloud_git_dest: "{{ cloud_prepare_repo_location }}"
    cloud_git_tmp_dir: >-
      {{ cloud_prepare_pod_base_dir }}/tmp/repo/{{ cloud_prepare_pod.repo }}
    cloud_git_update: "{{ cloud_prepare_cloud.type != 'local' }}"
    cloud_git_force: "{{ cloud_prepare_cloud.type != 'local' }}"
    cloud_git_dir_mode: "{{ (cloud_prepare_cloud.type == 'local') | ternary(0777, 0755) }}"

- set_fact:
    cloud_prepare_git_result: "{{ cloud_git_result }}"
  tags: ["no_print"]

- set_fact:
    cloud_prepare_git_commit: "{{ cloud_prepare_git_result.after }}"
    cloud_prepare_pod_env_dir: "{{ cloud_prepare_pod.env_dir | default('env') }}"
  tags: ["no_print"]

### Generate the environment pod context variables ###

- set_fact:
    cloud_prepare_params_pod:
      pod_id: "{{ cloud_prepare_pod_id }}"
      pod: "{{ cloud_prepare_pod }}"
      app: "{{ cloud_prepare_local_app_dict }}"
      git_commit: "{{ cloud_prepare_git_result.after }}"
      repo_name: "{{ cloud_prepare_env_name }}"
      repo:  "{{ cloud_prepare_pod_inner_repo }}"
      pod_env_dir: "{{ cloud_prepare_pod_env_dir | default('env') }}"
      repo_location: "{{ cloud_prepare_repo_location }}"
      data_dir: "{{ cloud_prepare_pod_data_dir }}"
      local_data_dir_inside: "{{ cloud_prepare_pod_local_data_dir_inside }}"
      env_cmd: "{{ cloud_prepare_env_cmd }}"
  tags: ["no_print"]

- set_fact:
    cloud_prepare_inner_credentials: {}
    cloud_prepare_inner_other_params: {}
  tags: ["no_print"]
  
- set_fact:
    cloud_prepare_inner_credentials: >-
      {{ 
      cloud_prepare_inner_credentials | 
      combine({ 
      cloud_prepare_inner_item.key: 
      cloud_prepare_credentials_dict[cloud_prepare_inner_item.value] }) 
      }}
  loop: "{{ cloud_prepare_pod.credentials | default({}) | dict2items }}"
  loop_control:
    loop_var: cloud_prepare_inner_item
    label: "{{ cloud_prepare_inner_item.key }} ({{ cloud_prepare_inner_item.value }})"
  tags: ["no_print"]
    
- set_fact:
    cloud_prepare_inner_other_params: >-
      {{ 
      cloud_prepare_inner_other_params | 
      combine({ 
      cloud_prepare_inner_item.key: 
      cloud_prepare_params_dict[cloud_prepare_inner_item.value] }) 
      }}
  loop: "{{ cloud_prepare_pod.other_params | default({}) | dict2items }}"
  loop_control:
    loop_var: cloud_prepare_inner_item
    label: "{{ cloud_prepare_inner_item.key }} ({{ cloud_prepare_inner_item.value }})"
  tags: ["no_print"]
    
### Generate a file with the environment variables and state (for idempotence) ###

- set_fact:
    cloud_prepare_vars_full:
      main: "{{ cloud_prepare_params }}"
      pod: "{{ cloud_prepare_params_pod }}"
      credentials: "{{ cloud_prepare_inner_credentials }}"
      other: "{{ cloud_prepare_inner_other_params }}"
  tags: ["no_print"]
    
- name: "{{ cloud_prepare_inner_title }} - create the temporary file to verify if there was a change"
  become: "{{ cloud_prepare_pod.root }}"
  copy: 
    content: "{{ cloud_prepare_vars_full | to_nice_yaml }}"
    dest: "{{ cloud_prepare_backup_file_tmp }}"
    owner: "{{ cloud_prepare_owner }}"
    group: "{{ cloud_prepare_group }}"
    mode: "{{ (cloud_prepare_cloud.type == 'local') | ternary(0666, 0640) }}"

- name: "{{ cloud_prepare_inner_title }} - get the difference of the 2 files (old and current)"
  become: "{{ cloud_prepare_pod.root }}"
  command: "diff {{ cloud_prepare_backup_file_tmp }} {{ cloud_prepare_backup_file }}"
  register: cloud_prepare_diff
  failed_when: cloud_prepare_diff.rc > 1
  changed_when: cloud_prepare_diff.rc == 1

### Continue the preparation only when changed from the previous ###

- block:

  ### Create the environment pod repositories in the env folders (when defined) ###

  - include_role: 
      name: "cloud_git"
    vars:
      cloud_prepare_pod_inner_env_repo: >-
        {{ cloud_prepare_repos_dict[cloud_prepare_pod_inner_item.repo] }}
      cloud_git_key: "{{ cloud_prepare_pod_inner_item.repo }}"
      cloud_git_title: >-
        {{ cloud_prepare_inner_title }} -
        environment pod repository
        ({{ cloud_prepare_repo_location }}/{{ 
        cloud_prepare_pod_inner_item.dir | default('') }})
      cloud_git_become: "{{ cloud_prepare_pod.root }}"
      cloud_git_repo: "{{ cloud_prepare_pod_inner_env_repo.src }}"
      cloud_git_version: "{{ cloud_prepare_pod_inner_env_repo.version }}"
      cloud_git_private: "{{ cloud_prepare_pod_inner_env_repo.private | default(false) }}"
      cloud_git_key_file_encrypted: >-
        {{ cloud_prepare_env_dir }}/{{ cloud_prepare_pod_inner_env_repo.key_file_encrypted }}
      cloud_git_dest: "{{ cloud_prepare_repo_location }}/{{ cloud_prepare_pod_inner_item.dir }}"
      cloud_git_tmp_dir: >-
        {{ cloud_prepare_pod_base_dir }}/tmp/repo/{{ cloud_prepare_pod_inner_item.repo }}
      cloud_git_update: "{{ cloud_prepare_cloud.type != 'local' }}"
      cloud_git_force: "{{ cloud_prepare_cloud.type != 'local' }}"
      cloud_git_dir_mode: "{{ (cloud_prepare_cloud.type == 'local') | ternary(0777, 0755) }}"
    loop: "{{ cloud_prepare_pod.env_repos | default([]) }}"
    loop_control:
      loop_var: cloud_prepare_pod_inner_item
      label: "{{ cloud_prepare_pod_inner_item.repo }}"

  ### Move the environment files and templates to the pod repository ###

  - set_fact:
      cloud_prepare_inner_env_dest_dirs: []
    tags: ["no_print"]

  - set_fact:
      cloud_prepare_inner_env_dest_dirs: >-
        {{ 
        cloud_prepare_inner_env_dest_dirs + 
        [cloud_prepare_pod_inner_item.dest | dirname] 
        }}
    loop: >-
      {{ 
      (cloud_prepare_pod.env_files | default([])) + 
      (cloud_prepare_pod.env_templates | default([])) 
      }}
    loop_control:
      loop_var: cloud_prepare_pod_inner_item
      label: "{{ cloud_prepare_pod_inner_item.dest }}"
    when: >-
      (cloud_prepare_pod_inner_item.when | default(true) | bool) 
      and 
      (cloud_prepare_pod_inner_item.dest | dirname | default('')) != ''
    tags: ["no_print"]

  - set_fact:
      cloud_prepare_inner_env_dest_dirs: "{{ cloud_prepare_inner_env_dest_dirs | unique }}"
    tags: ["no_print"]

  - name: "{{ cloud_prepare_inner_title }} - create the directories for the env files"
    become: "{{ cloud_prepare_pod.root }}"
    file:
      state: directory
      path: "{{ cloud_prepare_repo_location }}/{{ cloud_prepare_inner_item }}"
      owner: "{{ cloud_prepare_owner }}"
      group: "{{ cloud_prepare_group }}"
      mode: "{{ (cloud_prepare_cloud.type == 'local') | ternary(777, 751) }}"
    loop: "{{ cloud_prepare_inner_env_dest_dirs | default([]) }}"
    loop_control:
      loop_var: cloud_prepare_inner_item

  - set_fact:
      cloud_prepare_pod_env_files: []
      cloud_prepare_pod_env_templates: []
      cloud_prepare_pod_env_files_list: []
      cloud_prepare_pod_env_tpl_list: []
      cloud_prepare_pod_dir_list: []

  - set_fact:
      cloud_prepare_pod_env_files: >-
        {{ cloud_prepare_pod_env_files + [cloud_prepare_inner_item] }}
    loop: "{{ cloud_prepare_pod.env_files | default([]) }}"
    loop_control:
      loop_var: cloud_prepare_inner_item
    when: cloud_prepare_inner_item.when | default(true) | bool
    tags: ["no_print"]

  - set_fact:
      cloud_prepare_pod_env_templates: >-
        {{ cloud_prepare_pod_env_templates + [cloud_prepare_inner_item] }}
    loop: "{{ cloud_prepare_pod.env_templates | default([]) }}"
    loop_control:
      loop_var: cloud_prepare_inner_item
    when: cloud_prepare_inner_item.when | default(true) | bool
    tags: ["no_print"]

  - set_fact:
      cloud_prepare_pod_env_files_list: >-
        {{ 
        cloud_prepare_pod_env_files_list
        + [{ 
        'src': cloud_prepare_inner_item_src_full, 
        'dest': cloud_prepare_inner_item_dest_full, 
        'dest_rel': cloud_prepare_inner_item_dest_rel, 
        'mode': cloud_prepare_inner_item.mode | default(
        (cloud_prepare_cloud.type == 'local') | ternary(0666, ''), true)
        }] 
        }}
    vars: 
      cloud_prepare_inner_item_src_full: "{{ cloud_prepare_env_dir }}/{{ cloud_prepare_inner_item.src }}"
      cloud_prepare_inner_item_dest_rel: >-
        {{ 
        ((cloud_prepare_inner_item.root | default(false) | bool) | 
        ternary('', cloud_prepare_pod_env_dir + '/')) 
        + cloud_prepare_inner_item.dest
        }}
      cloud_prepare_inner_item_dest_full: >-
        {{ cloud_prepare_repo_location }}/{{ cloud_prepare_inner_item_dest_rel }}
      cloud_prepare_inner_item_params: "{{ cloud_prepare_inner_item.params | default({}) }}"
    loop: "{{ cloud_prepare_pod_env_files | default([]) }}"
    loop_control:
      loop_var: cloud_prepare_inner_item
      label: "{{ cloud_prepare_inner_item.dest }}"
    tags: ["no_print"]

  - set_fact:
      cloud_prepare_pod_env_tpl_list: >-
        {{ 
        cloud_prepare_pod_env_tpl_list
        + [{ 
        'src': cloud_prepare_inner_item_src_full, 
        'dest': cloud_prepare_inner_item_dest_full, 
        'dest_rel': cloud_prepare_inner_item_dest_rel, 
        'mode': cloud_prepare_inner_item.mode | default(
        (cloud_prepare_cloud.type == 'local') | ternary(0666, ''), true), 
        'params': cloud_prepare_inner_item_params
        }] 
        }}
    vars: 
      cloud_prepare_inner_item_src_full: "{{ cloud_prepare_env_dir }}/{{ cloud_prepare_inner_item.src }}"
      cloud_prepare_inner_item_dest_rel: >-
        {{ 
        ((cloud_prepare_inner_item.root | default(false) | bool) | 
        ternary('', cloud_prepare_pod_env_dir + '/')) 
        + cloud_prepare_inner_item.dest
        }}
      cloud_prepare_inner_item_dest_full: >-
        {{ cloud_prepare_repo_location }}/{{ cloud_prepare_inner_item_dest_rel }}
      cloud_prepare_inner_item_params: "{{ cloud_prepare_inner_item.params | default({}) }}"
    loop: "{{ cloud_prepare_pod_env_templates | default([]) }}"
    loop_control:
      loop_var: cloud_prepare_inner_item
      label: "{{ cloud_prepare_inner_item.dest }}"
    tags: ["no_print"]

  - set_fact:
      cloud_prepare_pod_dir_list: >-
        {{ cloud_prepare_pod_dir_list + [cloud_prepare_inner_item.dest | dirname] }}
    loop: >-
      {{ 
      (cloud_prepare_pod_env_files_list | default([])) 
      + 
      (cloud_prepare_pod_env_tpl_list | default([])) 
      }}
    loop_control:
      loop_var: cloud_prepare_inner_item
      label: "{{ cloud_prepare_inner_item.dest | dirname }}"
    tags: ["no_print"]

  - set_fact:
      cloud_prepare_pod_dir_list: >-
        {{ 
        cloud_prepare_pod_dir_list + [
        (cloud_prepare_repo_location + 
        '/tmp/tpl/' + 
        cloud_prepare_inner_item.dest_rel) | dirname
        ] }}
    loop: "{{ cloud_prepare_pod_env_tpl_list | default([]) }}"
    loop_control:
      loop_var: cloud_prepare_inner_item
      label: "{{ cloud_prepare_inner_item.dest | dirname }}"
    tags: ["no_print"]

  - name: "{{ cloud_prepare_inner_title }} - create the other directories"
    become: "{{ cloud_prepare_pod.root }}"
    file:
      state: directory
      path: "{{ cloud_prepare_inner_item }}"
      owner: "{{ cloud_prepare_owner }}"
      group: "{{ cloud_prepare_group }}"
      mode: "{{ (cloud_prepare_cloud.type == 'local') | ternary(777, 751) }}"
    loop: "{{ cloud_prepare_pod_dir_list | default([]) | unique | default([]) }}"
    loop_control:
      loop_var: cloud_prepare_inner_item
      label: "{{ cloud_prepare_inner_item }}"

  - name: "{{ cloud_prepare_inner_title }} - copy the pod env files to the specified locations"
    become: "{{ cloud_prepare_pod.root }}"
    copy:
      src: "{{ cloud_prepare_inner_item.src }}"
      dest: "{{ cloud_prepare_inner_item.dest }}"
      owner: "{{ cloud_prepare_owner }}"
      group: "{{ cloud_prepare_group }}"
      mode: >-
        {{ 
        cloud_prepare_inner_item.mode | default(
        (cloud_prepare_cloud.type == 'local') | ternary(0666, ''), true) 
        }}
    loop: "{{ cloud_prepare_pod_env_files_list | default([]) }}"
    loop_control:
      loop_var: cloud_prepare_inner_item
      label: "{{ cloud_prepare_inner_item.dest }}"
    tags: ["print_action"]
      
  - name: >-
      {{ cloud_prepare_inner_title }} - 
      transfer the pod env templates to the specified tmp locations
    become: "{{ cloud_prepare_pod.root }}"
    template: 
      src: "{{ cloud_prepare_inner_item.src }}"
      dest: "{{ cloud_prepare_repo_location }}/tmp/tpl/{{ cloud_prepare_inner_item.dest_rel }}"
      owner: "{{ cloud_prepare_owner }}"
      group: "{{ cloud_prepare_group }}"
      mode: >-
        {{ 
        cloud_prepare_inner_item.mode | default(
        (cloud_prepare_cloud.type == 'local') | ternary(0666, ''), true) 
        }}
    vars:
      params: "{{ cloud_prepare_inner_item.params }}"
    loop: "{{ cloud_prepare_pod_env_tpl_list | default([]) }}"
    loop_control:
      loop_var: cloud_prepare_inner_item
      label: "tmp/tpl/{{ cloud_prepare_inner_item.dest_rel }}"
    changed_when: false
    tags: ["print_action"]

  - name: >-
      {{ cloud_prepare_inner_title }} -
      remove excess of blank lines of files created from pod env templates
    replace:
      path: "{{ cloud_prepare_repo_location }}/tmp/tpl/{{ cloud_prepare_inner_item.dest_rel }}"
      regexp: "(^\\s*$)"
      replace: ""
    loop: "{{ cloud_prepare_pod_env_tpl_list | default([]) }}"
    loop_control:
      loop_var: cloud_prepare_inner_item
      label: "tmp/tpl/{{ cloud_prepare_inner_item.dest_rel }}"
    changed_when: false

  - name: >-
      {{ cloud_prepare_inner_title }} - 
      copy the normalized files created from pod env templates
    become: "{{ cloud_prepare_pod.root }}"
    copy:
      remote_src: true
      src: "{{ cloud_prepare_repo_location }}/tmp/tpl/{{ cloud_prepare_inner_item.dest_rel }}"
      dest: "{{ cloud_prepare_inner_item.dest }}"
      owner: "{{ cloud_prepare_owner }}"
      group: "{{ cloud_prepare_group }}"
      mode: >-
        {{ 
        cloud_prepare_inner_item.mode | default(
        (cloud_prepare_cloud.type == 'local') | ternary(0666, ''), true) 
        }}
    loop: "{{ cloud_prepare_pod_env_tpl_list | default([]) }}"
    loop_control:
      loop_var: cloud_prepare_inner_item
      label: "{{ cloud_prepare_inner_item.dest }}"
    tags: ["print_action"]

  ### Generate the environment pod expanded variables ###

  - set_fact:
      cloud_prepare_vars_volumes: []
      cloud_prepare_vars_files: []
      cloud_prepare_vars_templates: []
      cloud_prepare_vars_env_files: []
      cloud_prepare_vars_env_templates: []
      cloud_prepare_files_list: []
      cloud_prepare_tpl_list: []
      cloud_prepare_env_files_list: []
      cloud_prepare_env_tpl_list: []
      cloud_prepare_dir_list: [
        "{{ cloud_prepare_repo_location + '/' + (cloud_prepare_pod_env_dir | default('env')) }}"
      ]
    tags: ["no_print"]

  - name: "{{ cloud_prepare_inner_title }} - include_tasks - vars.yml"
    include_tasks: "vars.yml"
    vars:
      cloud_prepare_vars_ctx: 
        name: "{{ cloud_prepare_pod.ctx }}"
        params: "{{ cloud_prepare_vars_full }}"
    loop_control:
      loop_var: cloud_prepare_inner_item
      label: "{{ cloud_prepare_inner_item.name }}"

  ### Polish previous variables to use them directly later ###

  - set_fact:
      cloud_prepare_files_list: >-
        {{ 
        cloud_prepare_files_list
        + [{ 
        'src': cloud_prepare_inner_item_src_full, 
        'dest': cloud_prepare_inner_item_dest_full, 
        'mode': cloud_prepare_inner_item.mode | default(
        (cloud_prepare_cloud.type == 'local') | ternary(0666, ''), true)
        }] 
        }}
    vars: 
      cloud_prepare_inner_item_src_full: >-
        {{ cloud_prepare_repo_location }}/{{ cloud_prepare_inner_item.src }}
      cloud_prepare_inner_item_dest_full: >-
        {{ cloud_prepare_repo_location }}/{{ 
        ((cloud_prepare_inner_item.root | default(false) | bool) | 
        ternary('', cloud_prepare_pod_env_dir + '/')) 
        + (cloud_prepare_inner_item.dest | default(cloud_prepare_inner_item.src)) 
        }}
    loop: "{{ cloud_prepare_vars_files | default([]) }}"
    loop_control:
      loop_var: cloud_prepare_inner_item
      label: "{{ cloud_prepare_inner_item.dest | default(cloud_prepare_inner_item.src) }}"
    tags: ["no_print"]

  - set_fact:
      cloud_prepare_tpl_list: >-
        {{ 
        cloud_prepare_tpl_list
        + [{ 
        'src': cloud_prepare_inner_item_src_local_full,
        'dest': cloud_prepare_inner_item_dest_full, 
        'dest_rel': cloud_prepare_inner_item_dest_rel, 
        'mode': cloud_prepare_inner_item.mode | default(
        (cloud_prepare_cloud.type == 'local') | ternary(0666, ''), true), 
        'params': cloud_prepare_inner_item_params
        }] 
        }}
    vars: 
      cloud_prepare_inner_item_src_local_full: >-
        {{ cloud_prepare_local_pod_repo }}/{{ cloud_prepare_inner_item.src }}
      cloud_prepare_inner_item_dest_rel: >-
        {{ 
        ((cloud_prepare_inner_item.root | default(false) | bool) | 
        ternary('', cloud_prepare_pod_env_dir + '/')) 
        + (cloud_prepare_inner_item.dest | default(cloud_prepare_inner_item.src)) 
        }}
      cloud_prepare_inner_item_dest_full: >-
        {{ cloud_prepare_repo_location }}/{{ cloud_prepare_inner_item_dest_rel }}
      cloud_prepare_inner_item_params: "{{ cloud_prepare_inner_item.params | default({}) }}"
    loop: "{{ cloud_prepare_vars_templates | default([]) }}"
    loop_control:
      loop_var: cloud_prepare_inner_item
      label: "{{ cloud_prepare_inner_item.dest | default(cloud_prepare_inner_item.src) }}"
    tags: ["no_print"]

  - set_fact:
      cloud_prepare_env_files_list: >-
        {{ 
        cloud_prepare_env_files_list
        + [{ 
        'src': cloud_prepare_inner_item_src_full, 
        'dest': cloud_prepare_inner_item_dest_full, 
        'mode': cloud_prepare_inner_item.mode | default(
        (cloud_prepare_cloud.type == 'local') | ternary(0666, ''), true)
        }] 
        }}
    vars: 
      cloud_prepare_inner_item_src_full: "{{ cloud_prepare_env_dir }}/{{ cloud_prepare_inner_item.src }}"
      cloud_prepare_inner_item_dest_full: >-
        {{ cloud_prepare_repo_location }}/{{ 
        ((cloud_prepare_inner_item.root | default(false) | bool) | 
        ternary('', cloud_prepare_pod_env_dir + '/')) 
        + cloud_prepare_inner_item.dest
        }}
    loop: "{{ cloud_prepare_vars_env_files | default([]) }}"
    loop_control:
      loop_var: cloud_prepare_inner_item
      label: "{{ cloud_prepare_inner_item.dest }}"
    tags: ["no_print"]

  - set_fact:
      cloud_prepare_env_tpl_list: >-
        {{ 
        cloud_prepare_env_tpl_list
        + [{ 
        'src': cloud_prepare_inner_item_src_full, 
        'dest': cloud_prepare_inner_item_dest_full, 
        'dest_rel': cloud_prepare_inner_item_dest_rel, 
        'mode': cloud_prepare_inner_item.mode | default(
        (cloud_prepare_cloud.type == 'local') | ternary(0666, ''), true), 
        'params': cloud_prepare_inner_item_params
        }] 
        }}
    vars: 
      cloud_prepare_inner_item_src_full: "{{ cloud_prepare_env_dir }}/{{ cloud_prepare_inner_item.src }}"
      cloud_prepare_inner_item_dest_rel: >-
        {{ 
        ((cloud_prepare_inner_item.root | default(false) | bool) | 
        ternary('', cloud_prepare_pod_env_dir + '/')) 
        + cloud_prepare_inner_item.dest
        }}
      cloud_prepare_inner_item_dest_full: >-
        {{ cloud_prepare_repo_location }}/{{ cloud_prepare_inner_item_dest_rel }}
      cloud_prepare_inner_item_params: "{{ cloud_prepare_inner_item.params | default({}) }}"
    loop: "{{ cloud_prepare_vars_env_templates | default([]) }}"
    loop_control:
      loop_var: cloud_prepare_inner_item
      label: "{{ cloud_prepare_inner_item.dest }}"
    tags: ["no_print"]

  - set_fact:
      cloud_prepare_dir_list: >-
        {{ cloud_prepare_dir_list + [cloud_prepare_inner_item.dest | dirname] }}
    loop: >-
      {{ 
      (cloud_prepare_files_list | default([]))
      + 
      (cloud_prepare_tpl_list | default([])) 
      + 
      (cloud_prepare_env_files_list | default([])) 
      + 
      (cloud_prepare_env_tpl_list | default([])) 
      }}
    loop_control:
      loop_var: cloud_prepare_inner_item
      label: "{{ cloud_prepare_inner_item.dest | dirname }}"
    tags: ["no_print"]

  - set_fact:
      cloud_prepare_dir_list: >-
        {{ 
        cloud_prepare_dir_list + [
        (cloud_prepare_repo_location + 
        '/tmp/tpl/' + 
        cloud_prepare_inner_item.dest_rel) | dirname
        ] }}
    loop: >-
      {{ 
      (cloud_prepare_tpl_list | default([])) 
      + 
      (cloud_prepare_env_tpl_list | default([])) 
      }}
    loop_control:
      loop_var: cloud_prepare_inner_item
      label: "{{ cloud_prepare_inner_item.dest | dirname }}"
    tags: ["no_print"]

  ### Create the directories ###

  - name: "{{ cloud_prepare_inner_title }} - create the volume directories"
    become: "{{ cloud_prepare_pod.root }}"
    file:
      state: directory
      path: "{{ cloud_prepare_inner_item.path }}"
      owner: "{{ cloud_prepare_owner }}"
      group: "{{ cloud_prepare_group }}"
      mode: >-
        {{ 
        cloud_prepare_inner_item.mode | default(
        (cloud_prepare_cloud.type == 'local') | ternary(0777, ''), true) 
        }}
    loop: "{{ cloud_prepare_vars_volumes | default([]) }}"
    loop_control:
      loop_var: cloud_prepare_inner_item
      label: "{{ cloud_prepare_inner_item.path }}"
    tags: ["print_action"]

  - name: "{{ cloud_prepare_inner_title }} - create the other directories"
    become: "{{ cloud_prepare_pod.root }}"
    file:
      state: directory
      path: "{{ cloud_prepare_inner_item }}"
      owner: "{{ cloud_prepare_owner }}"
      group: "{{ cloud_prepare_group }}"
      mode: "{{ (cloud_prepare_cloud.type == 'local') | ternary(777, 751) }}"
    loop: "{{ cloud_prepare_dir_list | default([]) | unique | default([]) }}"
    loop_control:
      loop_var: cloud_prepare_inner_item
      label: "{{ cloud_prepare_inner_item }}"

  ### Transfer the needed files and templates ###

  - name: "{{ cloud_prepare_inner_title }} - copy the files to the specified locations"
    become: "{{ cloud_prepare_pod.root }}"
    copy:
      remote_src: true
      src: "{{ cloud_prepare_inner_item.src }}"
      dest: "{{ cloud_prepare_inner_item.dest }}"
      owner: "{{ cloud_prepare_owner }}"
      group: "{{ cloud_prepare_group }}"
      mode: >-
        {{ 
        cloud_prepare_inner_item.mode | default(
        (cloud_prepare_cloud.type == 'local') | ternary(0666, ''), true) 
        }}
    loop: "{{ cloud_prepare_files_list | default([]) }}"
    loop_control:
      loop_var: cloud_prepare_inner_item
      label: "{{ cloud_prepare_inner_item.dest }}"
    tags: ["print_action"]
      
  - name: >-
      {{ cloud_prepare_inner_title }} - 
      transfer the templates to the specified tmp locations
    become: "{{ cloud_prepare_pod.root }}"
    template: 
      src: "{{ cloud_prepare_inner_item.src }}"
      dest: "{{ cloud_prepare_repo_location }}/tmp/tpl/{{ cloud_prepare_inner_item.dest_rel }}"
      owner: "{{ cloud_prepare_owner }}"
      group: "{{ cloud_prepare_group }}"
      mode: >-
        {{ 
        cloud_prepare_inner_item.mode | default(
        (cloud_prepare_cloud.type == 'local') | ternary(0666, ''), true) 
        }}
    vars:
      params: "{{ cloud_prepare_inner_item.params }}"
    loop: "{{ cloud_prepare_tpl_list | default([]) }}"
    loop_control:
      loop_var: cloud_prepare_inner_item
      label: "tmp/tpl/{{ cloud_prepare_inner_item.dest_rel }}"
    changed_when: false
    tags: ["print_action"]

  - name: >-
      {{ cloud_prepare_inner_title }} -
      remove excess of blank lines of files created from templates
    replace:
      path: "{{ cloud_prepare_repo_location }}/tmp/tpl/{{ cloud_prepare_inner_item.dest_rel }}"
      regexp: "(^\\s*$)"
      replace: ""
    loop: "{{ cloud_prepare_tpl_list | default([]) }}"
    loop_control:
      loop_var: cloud_prepare_inner_item
      label: "tmp/tpl/{{ cloud_prepare_inner_item.dest_rel }}"
    changed_when: false

  - name: "{{ cloud_prepare_inner_title }} - copy the normalized files created from templates"
    become: "{{ cloud_prepare_pod.root }}"
    copy:
      remote_src: true
      src: "{{ cloud_prepare_repo_location }}/tmp/tpl/{{ cloud_prepare_inner_item.dest_rel }}"
      dest: "{{ cloud_prepare_inner_item.dest }}"
      owner: "{{ cloud_prepare_owner }}"
      group: "{{ cloud_prepare_group }}"
      mode: >-
        {{ 
        cloud_prepare_inner_item.mode | default(
        (cloud_prepare_cloud.type == 'local') | ternary(0666, ''), true) 
        }}
    loop: "{{ cloud_prepare_tpl_list | default([]) }}"
    loop_control:
      loop_var: cloud_prepare_inner_item
      label: "{{ cloud_prepare_inner_item.dest }}"
    tags: ["print_action"]

  - name: >-
      {{ cloud_prepare_inner_title }} - 
      copy the environment files to the specified locations
    become: "{{ cloud_prepare_pod.root }}"
    copy:
      src: "{{ cloud_prepare_inner_item.src }}"
      dest: "{{ cloud_prepare_inner_item.dest }}"
      owner: "{{ cloud_prepare_owner }}"
      group: "{{ cloud_prepare_group }}"
      mode: >-
        {{ 
        cloud_prepare_inner_item.mode | default(
        (cloud_prepare_cloud.type == 'local') | ternary(0666, ''), true) 
        }}
    loop: "{{ cloud_prepare_env_files_list | default([]) }}"
    loop_control:
      loop_var: cloud_prepare_inner_item
      label: "{{ cloud_prepare_inner_item.dest }}"
    tags: ["print_action"]
      
  - name: >-
      {{ cloud_prepare_inner_title }} -
      transfer the environment templates to the specified tmp locations
    become: "{{ cloud_prepare_pod.root }}"
    template: 
      src: "{{ cloud_prepare_inner_item.src }}"
      dest: "{{ cloud_prepare_repo_location }}/tmp/tpl/{{ cloud_prepare_inner_item.dest_rel }}"
      owner: "{{ cloud_prepare_owner }}"
      group: "{{ cloud_prepare_group }}"
      mode: >-
        {{ 
        cloud_prepare_inner_item.mode | default(
        (cloud_prepare_cloud.type == 'local') | ternary(0666, ''), true) 
        }}
    vars:
      params: "{{ cloud_prepare_inner_item.params }}"
    loop: "{{ cloud_prepare_env_tpl_list | default([]) }}"
    loop_control:
      loop_var: cloud_prepare_inner_item
      label: "tmp/tpl/{{ cloud_prepare_inner_item.dest_rel }}"
    changed_when: false
    tags: ["print_action"]

  - name: >-
      {{ cloud_prepare_inner_title }} -
      remove excess of blank lines of files created from environment templates
    replace:
      path: "{{ cloud_prepare_repo_location }}/tmp/tpl/{{ cloud_prepare_inner_item.dest_rel }}"
      regexp: "(^\\s*$)"
      replace: ""
    loop: "{{ cloud_prepare_env_tpl_list | default([]) }}"
    loop_control:
      loop_var: cloud_prepare_inner_item
      label: "tmp/tpl/{{ cloud_prepare_inner_item.dest_rel }}"
    changed_when: false

  - name: "{{ cloud_prepare_inner_title }} - copy the normalized files created from templates"
    become: "{{ cloud_prepare_pod.root }}"
    copy:
      remote_src: true
      src: "{{ cloud_prepare_repo_location }}/tmp/tpl/{{ cloud_prepare_inner_item.dest_rel }}"
      dest: "{{ cloud_prepare_inner_item.dest }}"
      owner: "{{ cloud_prepare_owner }}"
      group: "{{ cloud_prepare_group }}"
      mode: >-
        {{ 
        cloud_prepare_inner_item.mode | default(
        (cloud_prepare_cloud.type == 'local') | ternary(0666, ''), true) 
        }}
    loop: "{{ cloud_prepare_env_tpl_list | default([]) }}"
    loop_control:
      loop_var: cloud_prepare_inner_item
      label: "{{ cloud_prepare_inner_item.dest }}"
    tags: ["print_action"]
    
  - include_tasks: "ext/{{ cloud_prepare_pod_orchestration.type }}.build.yml"
    when: cloud_prepare_pod_orchestration.type != 'none'

  when: cloud_prepare_diff.changed or (cloud_prepare_cloud.type == 'local')

- name: "{{ cloud_prepare_inner_title }} - debug - inner"
  debug: 
    msg: "variables unchanged"
  when: not cloud_prepare_diff.changed
  tags: ["print_action"]