- name: "{{ cloud_prepare_normalize_title }}"
  set_fact:
    cloud_prepare_normalize_files: []
    cloud_prepare_normalize_templates: []
    cloud_prepare_normalize_files_list: []
    cloud_prepare_normalize_tpl_list: []
    cloud_prepare_normalize_dir_list: []
  tags: ["no_print"]

- name: "{{ cloud_prepare_normalize_title }}"
  set_fact:
    cloud_prepare_normalize_files: >-
      {{ cloud_prepare_normalize_files + [cloud_prepare_inner_item] }}
  loop: "{{ cloud_prepare_normalize_params.files | default([]) }}"
  loop_control:
    loop_var: cloud_prepare_inner_item
  when: cloud_prepare_inner_item.when | default(true) | bool
  tags: ["no_print"]

- name: "{{ cloud_prepare_normalize_title }}"
  set_fact:
    cloud_prepare_normalize_templates: >-
      {{ cloud_prepare_normalize_templates + [cloud_prepare_inner_item] }}
  loop: "{{ cloud_prepare_normalize_params.templates | default([]) }}"
  loop_control:
    loop_var: cloud_prepare_inner_item
  when: cloud_prepare_inner_item.when | default(true) | bool
  tags: ["no_print"]

- name: "{{ cloud_prepare_normalize_title }}"
  set_fact:
    cloud_prepare_normalize_files_list: >-
      {{ 
      cloud_prepare_normalize_files_list
      + [{ 
      'src': cloud_prepare_inner_item_src_full, 
      'dest': cloud_prepare_inner_item_dest_full, 
      'dest_rel': cloud_prepare_inner_item_dest_rel, 
      'mode': cloud_prepare_inner_item.mode | default(
      (cloud_prepare_cloud.type == 'local') | ternary(0666, ''), true)
      }] 
      }}
  vars: 
    cloud_prepare_inner_item_src_full: "{{ cloud_prepare_env_dir }}/{{ cloud_prepare_inner_item.src }}"
    cloud_prepare_inner_item_dest_rel: >-
      {{ 
      ((cloud_prepare_inner_item.root | default(false) | bool) | 
      ternary('', cloud_prepare_pod_env_dir + '/')) 
      + cloud_prepare_inner_item.dest
      }}
    cloud_prepare_inner_item_dest_full: >-
      {{ cloud_prepare_repo_location }}/{{ cloud_prepare_inner_item_dest_rel }}
    cloud_prepare_inner_item_params: "{{ cloud_prepare_inner_item.params | default({}) }}"
  loop: "{{ cloud_prepare_normalize_files | default([]) }}"
  loop_control:
    loop_var: cloud_prepare_inner_item
    label: "{{ cloud_prepare_inner_item.dest }}"
  tags: ["no_print"]

- name: "{{ cloud_prepare_normalize_title }}"
  set_fact:
    cloud_prepare_normalize_tpl_list: >-
      {{ 
      cloud_prepare_normalize_tpl_list
      + [{ 
      'src': cloud_prepare_inner_item_src_full, 
      'dest': cloud_prepare_inner_item_dest_full, 
      'dest_rel': cloud_prepare_inner_item_dest_rel, 
      'mode': cloud_prepare_inner_item.mode | default(
      (cloud_prepare_cloud.type == 'local') | ternary(0666, ''), true), 
      'params': cloud_prepare_inner_item_params
      }] 
      }}
  vars: 
    cloud_prepare_inner_item_src_full: "{{ cloud_prepare_env_dir }}/{{ cloud_prepare_inner_item.src }}"
    cloud_prepare_inner_item_dest_rel: >-
      {{ 
      ((cloud_prepare_inner_item.root | default(false) | bool) | 
      ternary('', cloud_prepare_pod_env_dir + '/')) 
      + cloud_prepare_inner_item.dest
      }}
    cloud_prepare_inner_item_dest_full: >-
      {{ cloud_prepare_repo_location }}/{{ cloud_prepare_inner_item_dest_rel }}
    cloud_prepare_inner_item_params: "{{ cloud_prepare_inner_item.params | default({}) }}"
  loop: "{{ cloud_prepare_normalize_templates | default([]) }}"
  loop_control:
    loop_var: cloud_prepare_inner_item
    label: "{{ cloud_prepare_inner_item.dest }}"
  tags: ["no_print"]

- name: "{{ cloud_prepare_normalize_title }}"
  set_fact:
    cloud_prepare_normalize_dir_list: >-
      {{ cloud_prepare_normalize_dir_list + [cloud_prepare_inner_item.dest | dirname] }}
  loop: >-
    {{ 
    (cloud_prepare_normalize_files_list | default([])) 
    + 
    (cloud_prepare_normalize_tpl_list | default([])) 
    }}
  loop_control:
    loop_var: cloud_prepare_inner_item
    label: "{{ cloud_prepare_inner_item.dest | dirname }}"
  tags: ["no_print"]

- name: "{{ cloud_prepare_normalize_title }}"
  set_fact:
    cloud_prepare_normalize_dir_list: >-
      {{ 
      cloud_prepare_normalize_dir_list + [
      (cloud_prepare_repo_location + 
      '/tmp/tpl/' + 
      cloud_prepare_inner_item.dest_rel) | dirname
      ] }}
  loop: "{{ cloud_prepare_normalize_tpl_list | default([]) }}"
  loop_control:
    loop_var: cloud_prepare_inner_item
    label: "{{ cloud_prepare_inner_item.dest | dirname }}"
  tags: ["no_print"]

- name: "{{ cloud_prepare_normalize_title }} - create the directories"
  become: "{{ cloud_prepare_pod.root }}"
  file:
    state: directory
    path: "{{ cloud_prepare_inner_item }}"
    owner: "{{ cloud_prepare_owner }}"
    group: "{{ cloud_prepare_group }}"
    mode: "{{ (cloud_prepare_cloud.type == 'local') | ternary(777, 751) }}"
  loop: "{{ cloud_prepare_normalize_dir_list | default([]) | unique | default([]) }}"
  loop_control:
    loop_var: cloud_prepare_inner_item
    label: "{{ cloud_prepare_inner_item }}"

- name: "{{ cloud_prepare_normalize_title }} - copy the files to the specified locations"
  become: "{{ cloud_prepare_pod.root }}"
  copy:
    src: "{{ cloud_prepare_inner_item.src }}"
    dest: "{{ cloud_prepare_inner_item.dest }}"
    owner: "{{ cloud_prepare_owner }}"
    group: "{{ cloud_prepare_group }}"
    mode: >-
      {{ 
      cloud_prepare_inner_item.mode | default(
      (cloud_prepare_cloud.type == 'local') | ternary(0666, ''), true) 
      }}
  loop: "{{ cloud_prepare_normalize_files_list | default([]) }}"
  loop_control:
    loop_var: cloud_prepare_inner_item
    label: "{{ cloud_prepare_inner_item.dest }}"
  tags: ["print_action"]
    
- name: >-
    {{ cloud_prepare_normalize_title }} - 
    transfer the templates to the specified tmp locations
  become: "{{ cloud_prepare_pod.root }}"
  template: 
    src: "{{ cloud_prepare_inner_item.src }}"
    dest: "{{ cloud_prepare_repo_location }}/tmp/tpl/{{ cloud_prepare_inner_item.dest_rel }}"
    owner: "{{ cloud_prepare_owner }}"
    group: "{{ cloud_prepare_group }}"
    mode: >-
      {{ 
      cloud_prepare_inner_item.mode | default(
      (cloud_prepare_cloud.type == 'local') | ternary(0666, ''), true) 
      }}
  vars:
    params: "{{ cloud_prepare_inner_item.params }}"
  loop: "{{ cloud_prepare_normalize_tpl_list | default([]) }}"
  loop_control:
    loop_var: cloud_prepare_inner_item
    label: "tmp/tpl/{{ cloud_prepare_inner_item.dest_rel }}"
  changed_when: false
  tags: ["print_action"]

- name: >-
    {{ cloud_prepare_normalize_title }} -
    remove excess of blank lines of files created from the templates
  replace:
    path: "{{ cloud_prepare_repo_location }}/tmp/tpl/{{ cloud_prepare_inner_item.dest_rel }}"
    regexp: "(^\\s*$)"
    replace: ""
  loop: "{{ cloud_prepare_normalize_tpl_list | default([]) }}"
  loop_control:
    loop_var: cloud_prepare_inner_item
    label: "tmp/tpl/{{ cloud_prepare_inner_item.dest_rel }}"
  changed_when: false

- name: >-
    {{ cloud_prepare_normalize_title }} - 
    copy the normalized files created from the templates
  become: "{{ cloud_prepare_pod.root }}"
  copy:
    remote_src: true
    src: "{{ cloud_prepare_repo_location }}/tmp/tpl/{{ cloud_prepare_inner_item.dest_rel }}"
    dest: "{{ cloud_prepare_inner_item.dest }}"
    owner: "{{ cloud_prepare_owner }}"
    group: "{{ cloud_prepare_group }}"
    mode: >-
      {{ 
      cloud_prepare_inner_item.mode | default(
      (cloud_prepare_cloud.type == 'local') | ternary(0666, ''), true) 
      }}
  loop: "{{ cloud_prepare_normalize_tpl_list | default([]) }}"
  loop_control:
    loop_var: cloud_prepare_inner_item
    label: "{{ cloud_prepare_inner_item.dest }}"
  tags: ["print_action"]